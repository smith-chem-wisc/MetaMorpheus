name: Install and Run

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  install:
    name: Create Installer Artifact
    runs-on: windows-latest

    env:
      DOTNET_VERSION: 8.0.204

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore dependencies
        run: dotnet restore ./MetaMorpheus/MetaMorpheus.sln

      - name: Build solution
        run: dotnet msbuild -v:minimal -p:Configuration=Release -p:UseSharedCompilation=false ./MetaMorpheus/

      - name: Build installer
        run: |
          msbuild ./MetaMorpheus/MetaMorpheusSetup/MetaMorpheusSetup.wixproj /p:Configuration=Release /verbosity=minimal /p:UseSharedCompilation=false
          msbuild ./MetaMorpheus/Bootstrapper/Bootstrapper.wixproj /p:Configuration=Release /p:UseSharedCompilation=false

      - name: Verify installer exists
        run: |
          if (!(Test-Path "./MetaMorpheus/MetaMorpheusSetup/bin/Release/MetaMorpheusInstaller.msi")) {
            Write-Host "❌ Installer build failed: MetaMorpheusInstaller.msi not found." -ForegroundColor Red
            exit 1
          }

      - name: Decrypt security certificate
        run: |
          nuget install secure-file -ExcludeVersion
          secure-file/tools/secure-file -decrypt MetaMorpheus/smith_MM_certificate.pfx.enc -secret ${{ secrets.KEY_SECRET }}

      - name: Sign installer
        run: |
          $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2("MetaMorpheus/smith_MM_certificate.pfx", "${{ secrets.KEY_CERT }}", "DefaultKeySet")
          Set-AuthenticodeSignature -FilePath "./MetaMorpheus/MetaMorpheusSetup/bin/Release/MetaMorpheusInstaller.msi" -Certificate $cert

      - name: Zip command-line version
        run: |
          7z a MetaMorpheus_CommandLine.zip .\MetaMorpheus\CMD\bin\Release\net8.0\* "-x!*.xml"

      # check that installer is greater than 1 kb to avoid pushing an empty artifact
      - name: Validate command-line zip artifact
        run: |
          if ((Get-Item MetaMorpheus_CommandLine.zip).length -lt 1kb) {
            Write-Host "❌ The build failed because the command-line .zip did not build properly; it is empty." -ForegroundColor Red
            exit 1
          }

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: MetaMorpheusInstaller
          path: ./MetaMorpheus/MetaMorpheusSetup/bin/Release/MetaMorpheusInstaller.msi

      - name: Upload command-line zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: MetaMorpheusCommandLine
          path: MetaMorpheus_CommandLine.zip


  test_installer:
    name: Search with Installed CMD
    runs-on: windows-latest
    needs: install

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.204
          
      - name: Download installer artifact
        uses: actions/download-artifact@v4
        with:
          name: MetaMorpheusInstaller

      - name: Install MetaMorpheus MSI
        run: |
          Start-Process -FilePath msiexec.exe -ArgumentList "/i `"$(Get-Location)\MetaMorpheusInstaller.msi`" /qn /l*v install.log" -Wait


      - name: Display workspace directory tree
        run: |
          function Show-Tree ($path, $indent = "") {
              Get-ChildItem -LiteralPath $path | ForEach-Object {
                  Write-Host "$indent|- $($_.Name)"
                  if ($_.PSIsContainer) {
                      Show-Tree -path $_.FullName -indent ("$indent   ")
                  }
              }
          }
          $workspace = Get-Location
          Write-Host "Workspace directory tree for: $workspace"
          Show-Tree $workspace
       
      - name: Microvinette with installed CMD.exe
        run: |
          $dataDir = "$(Get-Location)\MetaMorpheus\MetaMorpheus\Test\TestData"
          & "C:\Program Files\MetaMorpheus\CMD.exe" --test -o "$dataDir\exe_output" -v minimal
          if ($LASTEXITCODE -ne 0) {
            Write-Host "❌ CMD.exe search failed with exit code $LASTEXITCODE" -ForegroundColor Red
            exit $LASTEXITCODE
          }
          
      - name: Generate Default TOMLs with installed CMD.dll
        run: |
          dotnet "C:\Program Files\MetaMorpheus\CMD.dll" -g -o "$(Get-Location)\MetaMorpheus\Test\TestData"

      - name: Run search with installed CMD.dll
        run: |
          $dataDir = "$(Get-Location)\MetaMorpheus\Test\TestData"
          dotnet "C:\Program Files\MetaMorpheus\CMD.dll" -s "$dataDir\SmallCalibratible_Yeast.mzML" -d "$dataDir\SmallYeast.fasta" -t "$dataDir\SearchTask.toml" -o "$dataDir\dll_output" -v minimal
          if ($LASTEXITCODE -ne 0) {
            Write-Host "❌ CMD.dll search failed with exit code $LASTEXITCODE" -ForegroundColor Red
            exit $LASTEXITCODE
          }
          
  test_build:
    name: Search with Built CMD.dll
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.204

      - name: Restore dependencies
        run: dotnet restore ./MetaMorpheus/MetaMorpheus.sln

      - name: Build solution
        run: dotnet msbuild -v:minimal -p:Configuration=Release -p:UseSharedCompilation=false ./MetaMorpheus/

#      - name: Display workspace directory tree
#        run: |
#          function Show-Tree ($path, $indent = "") {
#              Get-ChildItem -LiteralPath $path | ForEach-Object {
#                  Write-Host "$indent|- $($_.Name)"
#                  if ($_.PSIsContainer) {
#                      Show-Tree -path $_.FullName -indent ("$indent   ")
#                  }
#              }
#          }
#          $workspace = Get-Location
#          Write-Host "Workspace directory tree for: $workspace"
#          Show-Tree $workspace

      - name: Generate Default TOMLs
        run: |
          dotnet "$(Get-Location)\MetaMorpheus\CMD\bin\Release\net8.0\CMD.dll" -g -o "$(Get-Location)\MetaMorpheus\CMD\bin\Release\net8.0\Data"

      - name: Run search with built CMD.dll
        run: |
          $dataDir = "$(Get-Location)\MetaMorpheus\CMD\bin\Release\net8.0\Data"
          dotnet "$(Get-Location)\MetaMorpheus\CMD\bin\Release\net8.0\CMD.dll" -s "$dataDir\SmallCalibratible_Yeast.mzML" -d "$dataDir\SmallYeast.fasta" -t "$dataDir\SearchTask.toml" -o "$dataDir\built_dll_output" -v minimal
          if ($LASTEXITCODE -ne 0) {
            Write-Host "❌ Built CMD.dll search failed with exit code $LASTEXITCODE" -ForegroundColor Red
            exit $LASTEXITCODE
          }

  ## Installs and builds. Verifies that the same dlls exist
  validate_installer_contents:
    name: Validate Installer Contents
    runs-on: windows-latest
    needs: install

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.204

      - name: Download installer artifact
        uses: actions/download-artifact@v4
        with:
          name: MetaMorpheusInstaller

      - name: Install MetaMorpheus MSI
        run: |
          Start-Process -FilePath msiexec.exe -ArgumentList "/i `"$(Get-Location)\MetaMorpheusInstaller.msi`" /qn /l*v install.log" -Wait

      - name: Restore dependencies
        run: dotnet restore ./MetaMorpheus/MetaMorpheus.sln

      - name: Build solution
        run: dotnet msbuild -v:minimal -p:Configuration=Release -p:UseSharedCompilation=false ./MetaMorpheus/

      - name: Compare built DLLs to installed DLLs
        run: |
          $buildDir = "$(Get-Location)\MetaMorpheus\CMD\bin\Release\net8.0"
          $installDir = "C:\Program Files\MetaMorpheus"

          $buildDlls = Get-ChildItem -Path $buildDir -Filter *.dll | Select-Object -ExpandProperty Name
          $installedDlls = Get-ChildItem -Path $installDir -Filter *.dll | Select-Object -ExpandProperty Name

          $missingDlls = $buildDlls | Where-Object { $_ -notin $installedDlls }

          if ($missingDlls.Count -gt 0) {
              Write-Host "❌ The following DLLs are in the build output but missing from the installer:" -ForegroundColor Red
              $missingDlls | ForEach-Object { Write-Host "- $_" }
              exit 1
          } else {
              Write-Host "✅ All built DLLs are present in the installed directory." -ForegroundColor Green
          }
