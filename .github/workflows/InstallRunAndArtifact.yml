name: Install and Run

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  install:
    name: Install MetaMorpheus
    runs-on: windows-latest

    env:
      DOTNET_VERSION: 8.0.204

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore dependencies
        run: dotnet restore ./MetaMorpheus/MetaMorpheus.sln

      - name: Build solution
        run: dotnet msbuild -v:minimal -p:Configuration=Release -p:UseSharedCompilation=false ./MetaMorpheus/

      - name: Build installer
        run: |
          msbuild ./MetaMorpheus/MetaMorpheusSetup/MetaMorpheusSetup.wixproj /p:Configuration=Release /verbosity=minimal /p:UseSharedCompilation=false
          msbuild ./MetaMorpheus/Bootstrapper/Bootstrapper.wixproj /p:Configuration=Release /p:UseSharedCompilation=false

      - name: Verify installer exists
        run: |
          if (!(Test-Path "./MetaMorpheus/MetaMorpheusSetup/bin/Release/MetaMorpheusInstaller.msi")) {
            Write-Host "❌ Installer build failed: MetaMorpheusInstaller.msi not found." -ForegroundColor Red
            exit 1
          }

      - name: Decrypt security certificate
        run: |
          nuget install secure-file -ExcludeVersion
          secure-file/tools/secure-file -decrypt MetaMorpheus/smith_MM_certificate.pfx.enc -secret ${{ secrets.KEY_SECRET }}

      - name: Sign installer
        run: |
          $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2("MetaMorpheus/smith_MM_certificate.pfx", "${{ secrets.KEY_CERT }}", "DefaultKeySet")
          Set-AuthenticodeSignature -FilePath "./MetaMorpheus/MetaMorpheusSetup/bin/Release/MetaMorpheusInstaller.msi" -Certificate $cert

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: MetaMorpheusInstaller
          path: ./MetaMorpheus/MetaMorpheusSetup/bin/Release/MetaMorpheusInstaller.msi

  test:
    name: Install Artifact and Search
    runs-on: windows-latest
    needs: install

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.204

      - name: Download installer artifact
        uses: actions/download-artifact@v4
        with:
          name: MetaMorpheusInstaller

      - name: Install MetaMorpheus MSI
        run: |
          Start-Process -FilePath msiexec.exe -ArgumentList "/i `"$(Get-Location)\MetaMorpheusInstaller.msi`" /qn /l*v install.log" -Wait
          if ($LASTEXITCODE -ne 0) {
            Write-Host "❌ Installation failed!" -ForegroundColor Red
            Get-Content install.log
            exit $LASTEXITCODE
          }

      - name: Validate installed CLI launches
        run: |
          $exePath = "C:\Program Files\MetaMorpheus\CMD.exe"
          if (!(Test-Path $exePath)) {
            Write-Host "❌ Installed executable not found!" -ForegroundColor Red
            exit 1
          }
          & "$exePath" --help
          if ($LASTEXITCODE -ne 0) {
            Write-Host "❌ Installed executable failed to run!" -ForegroundColor Red
            exit $LASTEXITCODE
          } else {
            Write-Host "✅ Installed executable ran successfully!" -ForegroundColor Green
          }

      - name: Run simple data search
        run: |
          $dataDir = "$(Get-Location)\TestData"
          $mzml = "$dataDir\SmallCalibratible_Yeast.mzML"
          $fasta = "$dataDir\SmallYeast.fasta"
          $task = "$dataDir\SearchTask.toml"
          $output = "$dataDir\SearchOutput"
          New-Item -ItemType Directory -Force -Path $output | Out-Null

          $exePath = "C:\Program Files\MetaMorpheus\CMD.exe"
          & "$exePath" -s "$mzml" -d "$fasta" -t "$task" -o "$output" -v minimal

          if ($LASTEXITCODE -ne 0) {
            Write-Host "❌ Simple data search failed!" -ForegroundColor Red
            exit $LASTEXITCODE
          } else {
            Write-Host "✅ Simple data search ran successfully!" -ForegroundColor Green
          }
